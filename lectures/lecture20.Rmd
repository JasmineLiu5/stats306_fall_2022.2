---
subtitle: "Stats 306: Lecture 20"
title: "Debugging Continued"
author: "Mark Fredrickson"
output: 
  learnr::tutorial:
    progressive: true
    css: css/lecture.css
runtime: shiny_prerendered
---


```{r setup, include=FALSE}
library(learnr)
library(tidyverse)


wikiart <- read_tsv("./data/WikiArt-Emotions-All.tsv.gz")
wikiart <- mutate(wikiart, Year = as.numeric(str_sub(Year, 1, 4)))

pivot_longer(wikiart, 
             matches(":"), 
             names_to = c("rating_type", "emotion"),
             names_sep = ":",
             values_to = "mean_annotation") -> wa_long

select(wa_long, Title, rating_type, emotion, mean_annotation)
wa_long <- mutate(wa_long,
                  emotion = str_replace(emotion, "\\s", ""))

filter(wa_long, str_detect(rating_type, "Art")) |>
  group_by(ID) |>
  arrange(desc(mean_annotation)) |>
  summarize(strongest_emotion = first(emotion),
            strongest_emotion_value = first(mean_annotation)) ->
  wa_art_strongest

wa_art_strong_year <- left_join(wikiart, wa_art_strongest, by = "ID")
```

## Review

* Wrapped up interation discussion
* Introduced `safely` as a way to capture error messages
* Debugging: finding errors in code
* General strategies: search, minimal cause, locate, fix and document

## Finding errors in the call stack 

(Run this in the console)

```{r}
f <- function(a) g(a)
g <- function(b) h(b)
h <- function(c) i(as.character(c))
i <- function(d) {
  if (!is.numeric(d)) {
    stop("`d` must be numeric", call. = FALSE)
  }
  d + 10
}
```
```{r eval = FALSE}
f("hello")
# Error: `d` must be numeric
```

Tools:

* `traceback()
* `library(rlang)` and `with_abort(f("hello"))` and `last_trace()`

## Using RStudio's debugger

```{r, eval = FALSE}
f(10)
```

## Using the browser

Add `browser()` in a function to pause execution and input commands:

* Any valid R code gets executed
* `help`: get available commands
* `next`, `n`: executes the next step in the function. 
* `step into`, `s`: step into the next function so you can explore it interactively.
* `finish`, or `f`: finishes execution of the current loop or function.
* `continue`, `c`: leaves interactive debugging and continues regular execution of the function.
* `stop`, `Q`: end debugging
* `where`: prints stack trace of active calls 

## Other tools

Open up `lecture20_debug.R`

## Debugging RMarkdown

If the problem only occurs when knitting, you will need to knit the document from the console using:

```{r, eval = FALSE}
rmarkdown::render("path/to/file.Rmd")
```

## Exercise

Open up `lecture20_debug_markdown.Rmd` and try to knit it.

Use `rmarkdown::render("lectures/lecture20_debug_markdown.Rmd` to find and fix the problem.

## Signals

R has several ways of signaling to the user that something is going on.

Messages:
```{r}
message("The value of pi is ", pi)
```

Warnings:
```{r}
warning("pi is not 3")
```

Errors:
```{r, eval = FALSE}
stop("You said pi was 3")
```

R has a `try`/`catch` mechanism for handling errors, though we won't go into detail.

## Debugging warnings


```{r}
f <- function(x) { 
  g(x - 1)
}
g <- function(x) {
  log(x) + 1
}

f(c(1, 2, -1, 10))
```

Promoting the warning into an error:
```{r, eval = FALSE}
options(warn = 2)
... do debugging ...
options(warn = 1) # back to normal

```

## Exercise

Where is the warning in this code coming from? Run this in the Console and use `options(warn = 2)` to help you debug it.

```{r}
pyramid_numbers <- function(x) {
  rep(x, x)
}

pyramid_numbers(1:3)

alternate_zeros <- function(x) {
  x * c(1, 0)
}

alternate_zeros(1:4)

both <- function(x) {
  alternate_zeros(pyramid_numbers(x))
}

both(1:3)
both(1:4)
both(1:5)
```

